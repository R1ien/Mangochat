<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.1, maximum-scale=1.1" />
  <title>MangoChat ü•≠</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f9d423, #ff4e50);
      color: #222;
      margin: 0;
      padding: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 2rem;
      user-select: none;
    }
    #messages {
      border: 2px solid #fff;
      border-radius: 10px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      background: rgba(255 255 255 / 0.6);
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 8px;
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .from-me {
      background: #ff4e50;
      color: #fff;
      margin-left: auto;
      text-align: right;
    }
    .from-them {
      background: #f9d423;
      color: #222;
      margin-right: auto;
      text-align: left;
    }
    #input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
    }
    #sendBtn {
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      background: #222;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    #sendBtn:disabled {
      background: #999;
      cursor: not-allowed;
    }
    #codeInput, #partnerCodeInput {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      margin-bottom: 10px;
    }
    #inviteBtn, #acceptBtn, #rejectBtn, #quitBtn {
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      background: #222;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
    }
    #inviteSection, #chatSection {
      margin-bottom: 20px;
    }
    #notification {
      text-align: center;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: none;
      font-weight: bold;
    }

    /* Mobile zoom */
    @media only screen and (max-width: 768px) {
      body {
        font-size: 1.2rem;
        padding: 10px;
      }
      input, button {
        font-size: 1.1rem;
        padding: 14px;
      }
      #messages {
        height: 250px;
      }
      #input-area {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
</head>
<body>

  <h1>MangoChat ü•≠</h1>

  <div id="notification"></div>

  <div id="inviteSection">
    <input id="codeInput" placeholder="Ton code utilisateur (ex: 1234)" />
    <input id="partnerCodeInput" placeholder="Code partenaire pour inviter" />
    <button id="inviteBtn">Envoyer invitation</button>
    <div id="invitationPending" style="display:none; margin-top: 10px;">
      Invitation en attente... <button id="cancelInviteBtn">Annuler</button>
    </div>
    <div id="inviteResponse" style="display:none; margin-top:10px;">
      <button id="acceptBtn">Accepter</button>
      <button id="rejectBtn">Refuser</button>
    </div>
  </div>

  <div id="chatSection" style="display:none;">
    <div id="messages"></div>
    <div id="input-area">
      <input id="messageInput" placeholder="√âcris un message..." autocomplete="off" />
      <button id="sendBtn" disabled>Envoyer</button>
    </div>
    <button id="quitBtn">‚ùå Quitter la conversation</button>
  </div>

  <script>
    // Pusher init
    const pusher = new Pusher('21da0af69d3d1b97e425', { cluster: 'eu', authEndpoint: '', encrypted: true, auth: { params: { user_id: '' } } });
    let myCode = null;
    let partner = null;
    let isAccepted = false;
    let currentChannel = null;

    // Elements
    const notificationEl = document.getElementById('notification');
    const codeInput = document.getElementById('codeInput');
    const partnerCodeInput = document.getElementById('partnerCodeInput');
    const inviteBtn = document.getElementById('inviteBtn');
    const cancelInviteBtn = document.getElementById('cancelInviteBtn');
    const invitationPending = document.getElementById('invitationPending');
    const inviteResponse = document.getElementById('inviteResponse');
    const acceptBtn = document.getElementById('acceptBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const chatSection = document.getElementById('chatSection');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const quitBtn = document.getElementById('quitBtn');

    // Afficher notification
    function showNotification(msg) {
      notificationEl.textContent = msg;
      notificationEl.style.display = 'block';
      setTimeout(() => {
        notificationEl.style.display = 'none';
      }, 4000);
    }

    // Ajouter un message √† l'affichage
    function addMessage(text, fromMe) {
      const div = document.createElement('div');
      div.textContent = (fromMe ? "Toi: " : "Lui: ") + text;
      div.className = 'message ' + (fromMe ? 'from-me' : 'from-them');
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Envoyer message via Pusher client events
    function sendMessage(text) {
      if (!currentChannel || !partner) return;
      if (!text.trim()) return;

      addMessage(text, true);
      currentChannel.trigger('client-new-message', {
        from: myCode,
        to: partner,
        text: text
      });
      messageInput.value = '';
      sendBtn.disabled = true;

      // Sauvegarder local
      let history = JSON.parse(localStorage.getItem('messageHistory') || '[]');
      history.push({ from: myCode, text: text });
      localStorage.setItem('messageHistory', JSON.stringify(history));
    }

    // Ecoute les messages entrants
    function subscribeToChat() {
      if (currentChannel) currentChannel.unbind_all();
      currentChannel = pusher.subscribe(`private-chat-${myCode}`);

      currentChannel.bind('client-new-message', data => {
        if (data.from === myCode) return; // Ignorer messages envoy√©s soi-m√™me

        if (data.text === "__quit__") {
          showNotification("‚ùå L'utilisateur a quitt√© la conversation.");
          setTimeout(() => { notificationEl.style.display = "none"; }, 5000);
          resetConversation();
          return;
        }

        addMessage(data.text, false);
        // Sauvegarder local
        let history = JSON.parse(localStorage.getItem('messageHistory') || '[]');
        history.push({ from: data.from, text: data.text });
        localStorage.setItem('messageHistory', JSON.stringify(history));
      });

      currentChannel.bind('client-invite', data => {
        if (data.to === myCode) {
          partner = data.from;
          inviteResponse.style.display = 'block';
          showNotification(`Nouvelle invitation de ${partner}`);
        }
      });

      currentChannel.bind('client-invite-accepted', data => {
        if (data.from === partner) {
          isAccepted = true;
          showNotification("Conversation accept√©e !");
          startChat();
        }
      });

      currentChannel.bind('client-invite-rejected', data => {
        if (data.from === partner) {
          inviteResponse.style.display = 'none';
          invitationPending.style.display = 'none';
          showNotification("Invitation refus√©e");
          resetConversation();
        }
      });

      currentChannel.bind('client-leave-conversation', data => {
        if (data.from === partner) {
          showNotification("‚ùå L'utilisateur a quitt√© la conversation.");
          setTimeout(() => { notificationEl.style.display = "none"; }, 5000);
          resetConversation();
        }
      });
    }

    // D√©marrer chat
    function startChat() {
      inviteResponse.style.display = 'none';
      invitationPending.style.display = 'none';
      chatSection.style.display = 'block';
      quitBtn.style.display = 'inline-block';
      messageInput.focus();
      sendBtn.disabled = true;

      // Charger historique local
      const history = JSON.parse(localStorage.getItem('messageHistory') || '[]');
      messagesEl.innerHTML = '';
      for (const m of history) {
        addMessage(m.text, m.from === myCode);
      }
    }

    // R√©initialiser conversation
    function resetConversation() {
      partner = null;
      isAccepted = false;
      localStorage.removeItem('partnerCode');
      localStorage.removeItem('messageHistory');
      chatSection.style.display = 'none';
      inviteResponse.style.display = 'none';
      invitationPending.style.display = 'none';
      quitBtn.style.display = 'none';
      messagesEl.innerHTML = '';
      messageInput.value = '';
      sendBtn.disabled = true;
      partnerCodeInput.value = '';
    }

    // Envoyer invitation
    inviteBtn.addEventListener('click', () => {
      const code = codeInput.value.trim();
      const partnerCode = partnerCodeInput.value.trim();
      if (!code || !partnerCode) {
        alert("Entre ton code et celui du partenaire");
        return;
      }
      if (code === partnerCode) {
        alert("Tu ne peux pas t'inviter toi-m√™me");
        return;
      }
      myCode = code;
      partner = partnerCode;
      localStorage.setItem('myCode', myCode);
      localStorage.setItem('partnerCode', partner);
      isAccepted = false;

      subscribeToChat();

      currentChannel.trigger('client-invite', {
        from: myCode,
        to: partner
      });

      invitationPending.style.display = 'block';
      inviteBtn.disabled = true;
    });

    cancelInviteBtn.addEventListener('click', () => {
      invitationPending.style.display = 'none';
      inviteBtn.disabled = false;
      resetConversation();
    });

    acceptBtn.addEventListener('click', () => {
      if (!partner) return;
      isAccepted = true;
      localStorage.setItem('partnerCode', partner);

      currentChannel.trigger('client-invite-accepted', {
        from: myCode,
        to: partner
      });

      startChat();
    });

    rejectBtn.addEventListener('click', () => {
      if (!partner) return;

      currentChannel.trigger('client-invite-rejected', {
        from: myCode,
        to: partner
      });

      resetConversation();
    });

    // Envoyer message
    sendBtn.addEventListener('click', () => {
      sendMessage(messageInput.value);
    });

    messageInput.addEventListener('input', () => {
      sendBtn.disabled = messageInput.value.trim().length === 0;
    });

    // Bouton quitter conversation
    quitBtn.addEventListener('click', () => {
      if (!partner || !isAccepted) return;

      currentChannel.trigger('client-new-message', {
        from: myCode,
        to: partner,
        text: "__quit__"
      });

      showNotification("‚ùå Tu as quitt√© la conversation.");

      resetConversation();
    });

    // Quitter conversation √† la fermeture ou reload page
    window.addEventListener('beforeunload', () => {
      if (!myCode || !partner) return;
      currentChannel.trigger('client-leave-conversation', {
        from: myCode,
        to: partner
      });
      resetConversation();
    });

    // Recharger infos au reload
    window.addEventListener('load', () => {
      myCode = localStorage.getItem('myCode');
      partner = localStorage.getItem('partnerCode');
      if (myCode && partner) {
        subscribeToChat();
        isAccepted = true;
        startChat();
      }
    });
  </script>
</body>
</html>
