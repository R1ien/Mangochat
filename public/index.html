<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.1, maximum-scale=1.1" />
<title>MangoChat ü•≠</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #ffec99, #fda085);
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
    height: 100vh; overflow: hidden;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 15px;
    user-select: none;
  }
  #login, #chat {
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 10px #ffa726aa;
    width: 100%;
    max-width: 400px;
  }
  #login {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  label {
    font-weight: bold;
  }
  input[type=text] {
    padding: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #f9a825;
    width: 100%;
  }
  button {
    background-color: #f9a825;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    color: #fff;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #ef6c00;
  }
  #chat {
    display: none;
    flex-direction: column;
    height: 80vh;
  }
  #messages {
    flex-grow: 1;
    background: #fff7e6;
    border-radius: 8px;
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 10px;
    font-size: 1rem;
  }
  .message {
    margin-bottom: 8px;
    word-wrap: break-word;
  }
  .message.me {
    color: #ef6c00;
    font-weight: bold;
    text-align: right;
  }
  .message.partner {
    color: #388e3c;
    font-weight: bold;
    text-align: left;
  }
  #input-area {
    display: flex;
    gap: 10px;
  }
  #messageInput {
    flex-grow: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #f9a825;
    font-size: 1rem;
  }
  #quitBtn {
    margin-top: 10px;
    background-color: #d84315;
  }
  #notif {
    background: #fff3e0;
    border: 1px solid #ffa726;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: none;
    font-weight: bold;
    text-align: center;
  }
  /* Mobile zoom */
  @media only screen and (max-width: 768px) {
    body {
      font-size: 1.2rem;
      padding: 10px;
    }
    input, button {
      font-size: 1rem;
      padding: 12px;
    }
    #messages {
      height: 250px;
    }
    #input-area {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
  }
</style>
</head>
<body>

<h1>MangoChat ü•≠</h1>

<div id="login">
  <label for="myPseudo">Ton pseudo :</label>
  <input id="myPseudo" type="text" placeholder="Ton pseudo" />
  
  <label for="partnerPseudo">Pseudo de la personne :</label>
  <input id="partnerPseudo" type="text" placeholder="Pseudo de ton contact" />
  
  <button id="sendInviteBtn">Envoyer invitation</button>
  
  <div id="notif" style="display:none;"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="input-area">
    <input id="messageInput" type="text" placeholder="√âcris un message..." />
    <button id="sendMsgBtn">Envoyer</button>
  </div>
  <button id="quitBtn" style="display:none;">‚ùå Quitter la conversation</button>
</div>

<script src="https://js.pusher.com/7.2/pusher.min.js"></script>
<script>
  // Variables globales
  let myPseudo = null;
  let partner = null;
  let isAccepted = false;
  let currentChannel = null;

  // Init Pusher (ta cl√© et cluster)
  const pusher = new Pusher('21da0af69d3d1b97e425', {
    cluster: 'eu',
    authEndpoint: '/pusher/auth', // Remplace par ton endpoint d‚Äôauth si besoin, sinon voir doc Pusher
    auth: {
      params: { user_id: '' },
      headers: {}
    }
  });

  // Helper afficher notif
  function showNotification(msg) {
    const notif = document.getElementById('notif');
    notif.innerText = msg;
    notif.style.display = 'block';
  }

  // Ajouter message √† l‚Äô√©cran
  function addMessage(text, isMe) {
    const messagesDiv = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message ' + (isMe ? 'me' : 'partner');
    div.textContent = (isMe ? 'Toi: ' : partner + ': ') + text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Envoie un message via Pusher
  function sendMessage(text) {
    if (!currentChannel || !isAccepted) return;
    addMessage(text, true);

    currentChannel.trigger('client-new-message', {
      from: myPseudo,
      to: partner,
      text
    });
  }

  // √âcoute les messages Pusher
  function subscribeToChat() {
    if (currentChannel) currentChannel.unsubscribe();
    currentChannel = pusher.subscribe('private-chat-' + myPseudo);

    currentChannel.bind('client-new-message', data => {
      if (data.from === myPseudo) return; // Ignore nos propres messages (affich√©s direct)

      if (data.text === '__quit__') {
        showNotification('‚ùå ' + partner + ' a quitt√© la conversation.');
        setTimeout(() => {
          document.getElementById('notif').style.display = 'none';
        }, 5000);

        resetConversation();
        return;
      }

      addMessage(data.text, false);
    });

    // Invitation re√ßue
    currentChannel.bind('client-invite', data => {
      if (data.to !== myPseudo) return;
      if (isAccepted || partner) return; // d√©j√† en conversation

      showNotification(`Invitation re√ßue de ${data.from} ! Accepter ?`);

      const accept = confirm(`Accepter la conversation avec ${data.from} ?`);
      if (accept) {
        partner = data.from;
        isAccepted = true;
        localStorage.setItem('partnerCode', partner);
        showNotification(`Conversation accept√©e avec ${partner}`);
        document.getElementById('quitBtn').style.display = 'block';
        subscribeToChat();
        currentChannel.trigger('client-accept', { from: myPseudo, to: partner });
        switchToChat();
      } else {
        showNotification('Invitation refus√©e.');
      }
    });

    // Invitation accept√©e
    currentChannel.bind('client-accept', data => {
      if (data.to !== myPseudo) return;

      partner = data.from;
      isAccepted = true;
      localStorage.setItem('partnerCode', partner);
      showNotification('Conversation accept√©e par ' + partner);
      document.getElementById('quitBtn').style.display = 'block';
      switchToChat();
    });

    // Quitter conversation
    currentChannel.bind('client-leave-conversation', data => {
      if (data.from === partner) {
        showNotification('‚ùå ' + partner + ' a quitt√© la conversation.');
        setTimeout(() => {
          document.getElementById('notif').style.display = 'none';
        }, 5000);
        resetConversation();
      }
    });
  }

  // Nettoyer la conversation
  function resetConversation() {
    partner = null;
    isAccepted = false;
    localStorage.removeItem('partnerCode');
    localStorage.removeItem('messageHistory');
    document.getElementById('messages').innerHTML = '';
    document.getElementById('input-area').style.display = 'none';
    document.getElementById('quitBtn').style.display = 'none';
  }

  // Passer de login √† chat
  function switchToChat() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').style.display = 'flex';
    document.getElementById('input-area').style.display = 'flex';
  }

  // Envoyer invitation
  document.getElementById('sendInviteBtn').addEventListener('click', () => {
    const myP = document.getElementById('myPseudo').value.trim();
    const partnerP = document.getElementById('partnerPseudo').value.trim();

    if (!myP || !partnerP) {
      alert('Remplis les deux pseudos');
      return;
    }
    if (myP === partnerP) {
      alert('Tu ne peux pas inviter toi-m√™me');
      return;
    }

    myPseudo = myP;
    partner = partnerP;

    localStorage.setItem('myPseudo', myPseudo);
    localStorage.setItem('partnerCode', partner);

    subscribeToChat();

    // Envoyer invitation
    currentChannel.trigger('client-invite', { from: myPseudo, to: partner });
    showNotification('Invitation envoy√©e √† ' + partner + ', en attente de r√©ponse...');
  });

  // Envoyer message
  document.getElementById('sendMsgBtn').addEventListener('click', () => {
    const text = document.getElementById('messageInput').value.trim();
    if (!text) return;
    sendMessage(text);
    document.getElementById('messageInput').value = '';
  });

  // Quitter conversation bouton
  document.getElementById('quitBtn').addEventListener('click', () => {
    if (!partner || !isAccepted) return;

    currentChannel.trigger('client-new-message', {
      from: myPseudo,
      to: partner,
      text: '__quit__'
    });

    showNotification('‚ùå Tu as quitt√© la conversation.');

    resetConversation();
  });

  // Quitter conversation √† la fermeture/rechargement
  window.addEventListener('beforeunload', () => {
    if (partner && isAccepted) {
      currentChannel.trigger('client-leave-conversation', {
        from: myPseudo,
        to: partner
      });
    }
    resetConversation();
  });

  // Au chargement, tentative de restauration si possible
  window.addEventListener('load', () => {
    myPseudo = localStorage.getItem('myPseudo');
    partner = localStorage.getItem('partnerCode');

    if (myPseudo && partner) {
      subscribeToChat();
      isAccepted = true;
      switchToChat();
      document.getElementById('quitBtn').style.display = 'block';
      showNotification('Reconnexion √† la conversation avec ' + partner);
    }
  });
</script>
</body>
</html>
