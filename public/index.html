<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.1, maximum-scale=1.1" />
<title>MangoChat ü•≠</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #ffec99, #fda085);
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
    height: 100vh; overflow: hidden;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    user-select: none;
  }
  #myPseudoDisplay {
    font-weight: bold;
    margin-bottom: 15px;
    font-size: 1.2rem;
    color: #ef6c00;
  }
  #login, #chat {
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 10px #ffa726aa;
    width: 100%;
    max-width: 400px;
  }
  #login {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  label {
    font-weight: bold;
  }
  input[type=text] {
    padding: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #f9a825;
    width: 100%;
  }
  button {
    background-color: #f9a825;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    color: #fff;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #ef6c00;
  }
  #chat {
    display: none;
    flex-direction: column;
    height: 80vh;
  }
  #messages {
    flex-grow: 1;
    background: #fff7e6;
    border-radius: 8px;
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 10px;
    font-size: 1rem;
  }
  .message {
    margin-bottom: 8px;
    word-wrap: break-word;
  }
  .message.me {
    color: #ef6c00;
    font-weight: bold;
    text-align: right;
  }
  .message.partner {
    color: #388e3c;
    font-weight: bold;
    text-align: left;
  }
  #input-area {
    display: flex;
    gap: 10px;
  }
  #messageInput {
    flex-grow: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #f9a825;
    font-size: 1rem;
  }
  #quitBtn {
    margin-top: 10px;
    background-color: #d84315;
  }
  #notif {
    background: #fff3e0;
    border: 1px solid #ffa726;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: none;
    font-weight: bold;
    text-align: center;
  }
  /* Mobile zoom */
  @media only screen and (max-width: 768px) {
    body {
      font-size: 1.2rem;
      padding: 10px;
    }
    input, button {
      font-size: 1rem;
      padding: 12px;
    }
    #messages {
      height: 250px;
    }
    #input-area {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
  }
</style>
</head>
<body>

<h1>MangoChat ü•≠</h1>

<div id="myPseudoDisplay" style="display:none;">
  Ton pseudo : <span id="pseudoText"></span>
</div>

<div id="login">
  <label for="partnerPseudo">Pseudo de la personne :</label>
  <input id="partnerPseudo" type="text" placeholder="Pseudo de ton contact" />
  
  <button id="sendInviteBtn">Envoyer invitation</button>
  
  <div id="notif" style="display:none;"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="input-area" style="display:none;">
    <input id="messageInput" type="text" placeholder="√âcris un message..." />
    <button id="sendMsgBtn">Envoyer</button>
  </div>
  <button id="quitBtn" style="display:none;">‚ùå Quitter la conversation</button>
</div>

<script src="https://js.pusher.com/7.2/pusher.min.js"></script>
<script>
  let myPseudo = null;
  let partner = null;
  let isAccepted = false;
  let currentChannel = null;

  // Demander pseudo une seule fois avec prompt
  function askPseudo() {
    let saved = localStorage.getItem('myPseudo');
    if (saved) {
      myPseudo = saved;
      showMyPseudo();
    } else {
      let p = null;
      do {
        p = prompt("Choisis ton pseudo (sans espace, max 15 caract√®res) :");
        if (!p) alert('Pseudo obligatoire');
        else if (p.length > 15) alert('Pseudo trop long');
        else if (p.trim() === '') alert('Pseudo invalide');
      } while (!p || p.trim() === '' || p.length > 15);
      myPseudo = p.trim();
      localStorage.setItem('myPseudo', myPseudo);

      // TODO: ici envoyer myPseudo au serveur pour sauvegarde dans la base
      // fetch('/save-pseudo', {method:'POST', body: JSON.stringify({pseudo: myPseudo}), headers:{'Content-Type':'application/json'}})
      showMyPseudo();
    }
  }

  // Afficher pseudo en haut
  function showMyPseudo() {
    document.getElementById('myPseudoDisplay').style.display = 'block';
    document.getElementById('pseudoText').textContent = myPseudo;
  }

  // Init Pusher
  const pusher = new Pusher('21da0af69d3d1b97e425', {
    cluster: 'eu',
  });

  function showNotification(msg) {
    const notif = document.getElementById('notif');
    notif.innerText = msg;
    notif.style.display = 'block';
  }

  function addMessage(text, isMe) {
    const messagesDiv = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message ' + (isMe ? 'me' : 'partner');
    div.textContent = (isMe ? 'Toi: ' : partner + ': ') + text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function sendMessage(text) {
    if (!currentChannel || !isAccepted) return;
    addMessage(text, true);

    currentChannel.trigger('client-new-message', {
      from: myPseudo,
      to: partner,
      text
    });
  }

  function subscribeToChat() {
    if (currentChannel) {
      pusher.unsubscribe('private-chat-' + myPseudo);
    }

    currentChannel = pusher.subscribe('private-chat-' + myPseudo);

    currentChannel.bind('client-new-message', data => {
      if (data.from === myPseudo) return;

      if (data.text === '__quit__') {
        showNotification('‚ùå ' + partner + ' a quitt√© la conversation.');
        setTimeout(() => {
          document.getElementById('notif').style.display = 'none';
        }, 5000);
        resetConversation();
        return;
      }

      addMessage(data.text, false);
    });

  currentChannel.bind('invite', data => {
  if (data.to !== myPseudo) return;
  if (isAccepted || partner) return;

  showNotification(`Invitation re√ßue de ${data.from} ! Accepter ?`);
  const accept = confirm(`Accepter la conversation avec ${data.from} ?`);
  if (accept) {
    partner = data.from;
    isAccepted = true;
    localStorage.setItem('partnerCode', partner);
    showNotification(`Conversation accept√©e avec ${partner}`);
    document.getElementById('quitBtn').style.display = 'block';
    subscribeToChat();
  } else {
    showNotification(`Invitation refus√©e.`);
  }
});


  function resetConversation() {
    partner = null;
    isAccepted = false;
    document.getElementById('messages').innerHTML = '';
    document.getElementById('input-area').style.display = 'none';
    document.getElementById('quitBtn').style.display = 'none';
  }

  window.onload = () => {
    askPseudo();
    subscribeToChat();

   document.getElementById('sendInviteBtn').onclick = () => {
  const target = document.getElementById('partnerPseudo').value.trim();
  if (!target) {
    alert('Entre un pseudo valide');
    return;
  }
  if (target === myPseudo) {
    alert('Tu ne peux pas t\'inviter toi-m√™me !');
    return;
  }

  fetch('http://localhost:3000/send-invite', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({from: myPseudo, to: target}),
  }).then(res => {
    if (res.ok) {
      showNotification(`Invitation envoy√©e √† ${target}. En attente de r√©ponse...`);
      partner = target;
      isAccepted = false;
    } else {
      alert('Erreur lors de l\'envoi de l\'invitation');
    }
  }).catch(() => alert('Erreur r√©seau'));
};

    document.getElementById('sendMsgBtn').onclick = () => {
      const msg = document.getElementById('messageInput').value.trim();
      if (!msg) return;
      sendMessage(msg);
      document.getElementById('messageInput').value = '';
      document.getElementById('input-area').style.display = 'flex';
    };

    document.getElementById('quitBtn').onclick = () => {
      if (!currentChannel || !partner) return;

      currentChannel.trigger('client-new-message', {
        from: myPseudo,
        to: partner,
        text: '__quit__'
      });
      resetConversation();
      showNotification('Tu as quitt√© la conversation.');
    };
  };
</script>

</body>
</html>
