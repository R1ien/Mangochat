<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.1" />
  <title>MangoChat ğŸ‹</title>
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #ffefba, #ffffff);
      padding: 10px;
      max-width: 600px;
      margin: auto;
    }
    #messages {
      border: 1px solid #ccc;
      height: 250px;
      overflow-y: auto;
      padding: 5px;
      margin-top: 10px;
      background-color: #fffbe6;
    }
    #input-area {
      display: none;
      margin-top: 10px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
    }
    #quitBtn {
      display: none;
      margin-top: 10px;
    }
    #notif {
      color: green;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <main>
    <h2>ğŸ‹ MangoChat</h2>
    <div id="notif"></div>
    <div id="nameDisplay"></div>

    <div id="inviteBox">
      <input type="text" id="inviteInput" placeholder="Pseudo Ã  inviter" />
      <button id="inviteBtn">ğŸ“¨ Inviter</button>
    </div>

    <div id="messages"></div>

    <div id="input-area">
      <input type="text" id="msgInput" placeholder="Ã‰cris ton message" />
      <button id="sendBtn">ğŸ“¤ Envoyer</button>
    </div>

    <button id="quitBtn">âŒ Quitter la conversation</button>

    <!-- ğŸŸ¢ Interface d'appel -->
<div id="callInterface" style="display:none; position:fixed; bottom:20px; right:20px; background:#fff3e0; padding:15px; border-radius:15px; box-shadow:0 0 10px rgba(0,0,0,0.2);">
  <p style="margin:0 0 10px;">ğŸ”Š En appel...</p>
  <button id="muteBtn">ğŸ”‡ Mute</button>
  <button id="hangupBtn" style="margin-left:10px; background:#f44336; color:white;">âŒ Raccrocher</button>
</div>

<!-- ğŸ”˜ Bouton pour lancer un appel -->
<button id="callBtn" style="position:fixed; bottom:20px; left:20px;">ğŸ“ Appeler</button>
  </main>

  <script>
    const myName = localStorage.getItem("myName") || prompt("Entre ton pseudo :").trim();
localStorage.setItem("myName", myName);
document.getElementById("nameDisplay").textContent = "ğŸ‘¤ Ton pseudo : " + myName;

const pusher = new Pusher("21da0af69d3d1b97e425", {
  cluster: "eu"
});

let partner = null;
let currentChannel = null;
let isSubscribed = false;  // <-- Pour Ã©viter plusieurs abonnements

const notif = msg => {
  const n = document.getElementById("notif");
  n.textContent = msg;
  n.style.display = "block";
  setTimeout(() => n.style.display = "none", 5000);
};

const getChannelName = (a, b) => {
  return "chat_" + [a, b].sort().join("_");
};

document.getElementById("inviteBtn").onclick = () => {
  const to = document.getElementById("inviteInput").value.trim();
  if (!to || to === myName) return alert("Pseudo invalide");

  fetch("/invite", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ from: myName, to })
  });

  partner = to;
  notif("ğŸ“¨ Invitation envoyÃ©e Ã  " + to);
};

const subscribeToChat = () => {
  if (isSubscribed && currentChannel) {
    // On est dÃ©jÃ  abonnÃ©, on ne fait rien pour Ã©viter doublons
    return;
  }
  if (currentChannel) {
    // Si on a un ancien channel, on le dÃ©sabonne proprement
    pusher.unsubscribe(currentChannel.name);
  }

  const channelName = getChannelName(myName, partner);
  currentChannel = pusher.subscribe(channelName);

  currentChannel.bind("new-message", data => {
    // Ignore les messages envoyÃ©s par moi-mÃªme reÃ§us via Pusher pour Ã©viter doublons
    if (data.from === myName) return;

    if (data.text === "__quit__") {
      notif("ğŸšª L'autre utilisateur a quittÃ© la conversation.");
      cleanup();
      return;
    }
    addMessage(data.from, data.text);
  });

  currentChannel.bind("chat-started", data => {
    notif(data.message);
  });

  document.getElementById("input-area").style.display = "block";
  document.getElementById("quitBtn").style.display = "block";

  isSubscribed = true;  // <-- Marque quâ€™on est abonnÃ©
};

const addMessage = (sender, text) => {
  const div = document.createElement("div");
  div.textContent = `${sender} : ${text}`;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = 99999;
};

document.getElementById("sendBtn").onclick = () => {
  const text = document.getElementById("msgInput").value.trim();
  if (!text || !partner) return;
  fetch("/message", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ from: myName, to: partner, text })
  });
  addMessage("Toi", text); // Affiche directement ton message, pas besoin dâ€™attendre Pusher
  document.getElementById("msgInput").value = "";
};

// ğŸ”” Invitation reÃ§ue
const inviteChannel = pusher.subscribe("invite_" + myName);
inviteChannel.bind("chat-invite", data => {
  if (confirm(`${data.from} veut discuter avec toi. Accepter ?`)) {
    partner = data.from;
    fetch("/accept", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from: myName, to: partner })
    });
    subscribeToChat();
  }
});

// ğŸ‰ Acceptation reÃ§ue
inviteChannel.bind("chat-accepted", data => {
  if (!partner) partner = data.from;
  subscribeToChat();
});

// âŒ Quitter
document.getElementById("quitBtn").onclick = () => {
  fetch("/message", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ from: myName, to: partner, text: "__quit__" })
  });
  notif("ğŸšª Tu as quittÃ© la conversation.");
  cleanup();
};

const cleanup = () => {
  document.getElementById("messages").innerHTML = "";
  document.getElementById("input-area").style.display = "none";
  document.getElementById("quitBtn").style.display = "none";
  if (currentChannel) {
    pusher.unsubscribe(currentChannel.name);
    currentChannel = null;
    isSubscribed = false;
  }
  partner = null;
};

// ğŸ”„ Si on recharge la page
window.addEventListener("beforeunload", () => {
  if (partner) {
    fetch("/message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from: myName, to: partner, text: "__quit__" })
    });
  }
});
  </script>
  <script src="call.js"></script>
</body>
</html>
