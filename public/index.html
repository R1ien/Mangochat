<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mangochat - Chat tropical ü•≠</title>
  <style>
    /* RESET & BASE */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f9d976, #f39f86);
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: #4e342e;
    }
    header {
      background: #f57c00;
      color: white;
      font-size: 1.5rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
      user-select: none;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      gap: 0.5rem;
      overflow: hidden;
    }

    #messages {
      flex: 1;
      background: #fff3e0;
      border-radius: 10px;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: inset 0 0 10px #f57c0077;
    }

    .message {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.3;
      font-weight: 500;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
      transition: background-color 0.3s ease;
    }
    .mine {
      background-color: #ffe082;
      color: #5d4037;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .other {
      background-color: #fff;
      color: #6d4c41;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    #input-area {
      display: flex;
      gap: 0.5rem;
    }
    #input-msg {
      flex: 1;
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 20px;
      border: none;
      outline: none;
      box-shadow: 0 0 5px #f57c00aa;
      transition: box-shadow 0.2s ease-in-out;
    }
    #input-msg:focus {
      box-shadow: 0 0 8px #f57c00cc;
    }
    button {
      background: #f57c00;
      border: none;
      color: white;
      padding: 10px 16px;
      font-weight: 600;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover {
      background: #ef6c00;
    }
    #quitBtn {
      background: #d84315;
      margin-top: 0.5rem;
    }
    #quitBtn:hover {
      background: #bf360c;
    }

    #notif {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff3e0cc;
      padding: 10px 20px;
      border-radius: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-weight: 600;
      color: #6d4c41;
      display: none;
      user-select: none;
      z-index: 1000;
    }

    /* MOBILE */
    @media (max-width: 600px) {
      body {
        font-size: 1.1rem;
        zoom: 1.1;
      }
      #messages {
        padding: 8px;
      }
      #input-msg {
        font-size: 1.1rem;
      }
      button {
        padding: 12px 20px;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>

  <header>ü•≠ Mangochat - Tropical Chat</header>

  <main>
    <div id="notif"></div>

    <div id="messages"></div>

    <div id="input-area" style="display:none;">
      <input type="text" id="input-msg" placeholder="√âcris ton message..." autocomplete="off" />
      <button id="sendBtn">Envoyer</button>
    </div>

    <button id="quitBtn" style="display:none;">‚ùå Quitter la conversation</button>
  </main>

  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <script>
    // Variables globales
    let myCode = localStorage.getItem('myCode') || null;
    let partner = null;
    let isAccepted = false;

    // Pusher config
    const pusher = new Pusher("21da0af69d3d1b97e425", { cluster: "eu", authEndpoint: "/pusher/auth" });
    let currentChannel = null;

    // Demande ton pseudo au d√©but si jamais pas dans localStorage
    async function askPseudo() {
      while (!myCode) {
        const pseudo = prompt("Choisis ton pseudo (unique) :");
        if (pseudo && pseudo.trim().length >= 3) {
          myCode = pseudo.trim();
          localStorage.setItem('myCode', myCode);
          showNotification(`Bienvenue, ${myCode} !`);
          break;
        }
      }
    }

    // Afficher notification temporaire
    function showNotification(text) {
      const notif = document.getElementById("notif");
      notif.innerText = text;
      notif.style.display = "block";
      setTimeout(() => {
        notif.style.display = "none";
      }, 4000);
    }

    // Affiche message dans #messages avec bulle gauche/droite
    function addMessage(text, isMine) {
      const div = document.createElement("div");
      div.className = "message " + (isMine ? "mine" : "other");
      div.innerText = text;
      document.getElementById("messages").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    }

    // Envoie un message
    async function sendMessage() {
      const input = document.getElementById("input-msg");
      const text = input.value.trim();
      if (!text || !partner || !isAccepted) return;

      addMessage(text, true);

      try {
        await fetch("/message", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({from: myCode, to: partner, text})
        });
      } catch {
        showNotification("Erreur lors de l'envoi !");
      }
      input.value = "";
    }

    // G√©rer r√©ception de messages Pusher
    function bindChatChannel(channelName) {
      if (currentChannel) currentChannel.unsubscribe();
      currentChannel = pusher.subscribe(channelName);

      currentChannel.bind("new-message", data => {
        if (data.from === myCode) return; // Ignore tes propres messages

        addMessage(data.text, false);
      });

      currentChannel.bind("chat-started", data => {
        showNotification(data.message || "Conversation commenc√©e !");
      });

      currentChannel.bind("user-left", data => {
        showNotification(data.message || "L'autre utilisateur a quitt√©.");
        partner = null;
        isAccepted = false;
        resetChatUI();
      });
    }

    // Reset interface chat
    function resetChatUI() {
      document.getElementById("messages").innerHTML = "";
      document.getElementById("input-area").style.display = "none";
      document.getElementById("quitBtn").style.display = "none";
    }

    // Envoie invitation
    async function sendInvite(to) {
      if (to === myCode) {
        showNotification("Tu ne peux pas t'inviter toi-m√™me !");
        return;
      }
      try {
        await fetch("/invite", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({from: myCode, to})
        });
        showNotification(`Invitation envoy√©e √† ${to} !`);
      } catch {
        showNotification("Erreur lors de l'invitation !");
      }
    }

    // Bind invitation channel
    function bindInviteChannel() {
      const inviteChannel = pusher.subscribe("invite_" + myCode);

      inviteChannel.bind("chat-invite", data => {
        const fromUser = data.from;
        if (confirm(`üì© ${fromUser} veut discuter avec toi. Accepter ?`)) {
          fetch("/accept", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({from: myCode, to: fromUser})
          });

          partner = fromUser;
          isAccepted = true;
          showNotification("Conversation accept√©e !");
          bindChatChannel(getChatChannel(myCode, partner));
          document.getElementById("input-area").style.display = "flex";
          document.getElementById("quitBtn").style.display = "inline-block";
        } else {
          showNotification("Invitation refus√©e.");
        }
      });

      inviteChannel.bind("chat-accepted", data => {
        if (data.from === partner) {
          isAccepted = true;
          showNotification("Conversation accept√©e par " + partner);
          bindChatChannel(getChatChannel(myCode, partner));
          document.getElementById("input-area").style.display = "flex";
          document.getElementById("quitBtn").style.display = "inline-block";
        }
      });
    }

    // Helper channel name (ordre alphab√©tique)
    function getChatChannel(a, b) {
      return "chat_" + [a, b].sort().join("_");
    }

    // Quitter la conversation
    async function quitConversation() {
      if (!partner) return;

      await fetch("/message", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({from: myCode, to: partner, text: "__quit__"})
      });

      showNotification("‚ùå Tu as quitt√© la conversation.");

      partner = null;
      isAccepted = false;
      resetChatUI();
    }

    // Gestion message sp√©cial quitter
    function handleSpecialMessages(data) {
      if (data.text === "__quit__") {
        showNotification("‚ùå L'utilisateur a quitt√© la conversation.");
        partner = null;
        isAccepted = false;
        resetChatUI();
        return true;
      }
      return false;
    }

    // √âcoute message "new-message" pour g√©rer quitter et messages normaux
    function extendedBindChatChannel(channelName) {
      if (currentChannel) currentChannel.unsubscribe();
      currentChannel = pusher.subscribe(channelName);

      currentChannel.bind("new-message", data => {
        if (data.from === myCode) return; // Ignore tes messages

        if (handleSpecialMessages(data)) return;

        addMessage(data.text, false);
      });

      currentChannel.bind("chat-started", data => {
        showNotification(data.message || "Conversation commenc√©e !");
      });

      currentChannel.bind("user-left", data => {
        showNotification(data.message || "L'autre utilisateur a quitt√©.");
        partner = null;
        isAccepted = false;
        resetChatUI();
      });
    }

    // √âv√©nements
    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("input-msg").addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });
    document.getElementById("quitBtn").onclick = quitConversation;

    // Initialisation
    (async () => {
      await askPseudo();
      bindInviteChannel();

      // Demande √† qui tu veux parler
      const toUser = prompt("√Ä qui veux-tu envoyer une invitation ? (pseudo)");
      if (!toUser || toUser.trim().length < 3) {
        showNotification("Invitation annul√©e : pseudo invalide.");
        return;
      }

      partner = toUser.trim();
      await sendInvite(partner);
    })();

  </script>
</body>
</html>
