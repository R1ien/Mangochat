<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MangoChat üçã</title>
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    #messages { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; background: #f5f5f5; }
    .message { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
    .from-me { background: #DCF8C6; margin-left: auto; }
    .from-them { background: #fff; border: 1px solid #ccc; margin-right: auto; }
    #input-area { display: none; margin-top: 10px; }
    #messageInput { padding: 10px; font-size: 16px; width: 100%; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 5px; }
    #notif { background: yellow; padding: 10px; margin-top: 10px; display: none; }
  </style>
</head>
<body>

<h2>Ton code : <span id="myCode"></span></h2>
<input id="partnerCode" placeholder="Code de l'autre..." style="width: 100%; padding: 8px;" />
<button onclick="connect()">Demander √† discuter</button>

<div id="notif">
  <span id="notifText"></span><br />
  <button onclick="acceptInvite()">Oui</button>
  <button onclick="declineInvite()">Non</button>
</div>

<div id="messages"></div>

<div id="input-area">
  <input id="messageInput" placeholder="√âcris un message..." autocomplete="off" />
  <button onclick="send()">Envoyer</button>
</div>

<script>
  const myCode = localStorage.getItem("code") || Math.floor(100000 + Math.random() * 900000).toString();
  localStorage.setItem("code", myCode);
  document.getElementById("myCode").textContent = myCode;

  let partner = "";
  let isAccepted = false;
  let chatChannel = null;

  const pusher = new Pusher("21da0af69d3d1b97e425", { cluster: "eu" });
  const inviteChannel = pusher.subscribe("invite_" + myCode);

  inviteChannel.bind("chat-invite", data => {
    showNotification(`${data.from} veut discuter avec toi. Accepter ?`);
    window.inviteFrom = data.from;
  });

  inviteChannel.bind("chat-accepted", data => {
    if (data.from !== partner) return;
    isAccepted = true;
    subscribeToChat(partner);
    document.getElementById("input-area").style.display = "block";
    showNotification("L'autre a accept√© l'invitation !", false);
  });

  function showNotification(text, show = true) {
    document.getElementById("notif").style.display = show ? "block" : "none";
    document.getElementById("notifText").textContent = text || "";
  }

  function acceptInvite() {
    const from = window.inviteFrom;
    isAccepted = true;
    partner = from;
    document.getElementById("partnerCode").value = partner;
    subscribeToChat(partner);
    document.getElementById("input-area").style.display = "block";
    showNotification("", false);

    fetch("/accept", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from: myCode, to: partner })
    });
  }

  function declineInvite() {
    showNotification("", false);
  }

  function connect() {
    const to = document.getElementById("partnerCode").value.trim();
    if (!to || to === myCode) return;
    partner = to;

    fetch("/invite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from: myCode, to })
    });
  }

  function getChatChannel(a, b) {
    return 'chat_' + [a, b].sort().join('_');
  }

  function subscribeToChat(other) {
    const chName = getChatChannel(myCode, other);
    if (chatChannel) pusher.unsubscribe(chatChannel);
    chatChannel = pusher.subscribe(chName);

    chatChannel.bind("new-message", data => {
      const fromMe = data.from === myCode;
      addMessage(data.text, fromMe);
    });
  }

  function addMessage(text, fromMe) {
    const messagesDiv = document.getElementById("messages");
    const msgDiv = document.createElement("div");
    msgDiv.className = "message " + (fromMe ? "from-me" : "from-them");
    msgDiv.textContent = (fromMe ? "Toi: " : "Lui: ") + text;
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function send() {
    const textInput = document.getElementById("messageInput");
    const text = textInput.value.trim();
    if (!text || !partner || !isAccepted) return;

    fetch("/message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from: myCode, to: partner, text })
    });

    textInput.value = "";
    textInput.focus();
  }
</script>

</body>
</html>
