<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ¥­ MangoChat</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
</head>
<body>
  <div id="app">
    <h1 class="logo">ðŸ¥­ MangoChat</h1>
    <div id="my-code-box">
      Ton code : <span id="my-code"></span>
    </div>

    <div id="invite-section">
      <input id="code-input" placeholder="Code de ton ami" maxlength="10" />
      <button onclick="sendInvite()">Inviter</button>
    </div>

    <div id="notifications"></div>

    <div id="messages" style="display:none;"></div>

    <div id="input-area" style="display:none;">
      <input id="message-input" placeholder="Ã‰cris ton message...">
      <button onclick="sendMessage()" style="background:#c06e2e;color:white;">Envoyer</button>
      <button onclick="quitChat()" id="quit-btn">Quitter</button>
    </div>
  </div>

  <script>
    const myCode = localStorage.getItem("myCode") || Math.random().toString(36).substr(2, 6);
    localStorage.setItem("myCode", myCode);
    document.getElementById("my-code").textContent = myCode;

    const pusher = new Pusher("21da0af69d3d1b97e425", {
      cluster: "eu"
    });

    let partner = null;
    let currentChannel = null;
    let isAccepted = false;

    const inviteChannel = pusher.subscribe("invite_" + myCode);
    inviteChannel.bind("chat-invite", data => {
      if (!partner) {
        partner = data.from;
        showNotification(`ðŸ’¬ Invitation de ${partner}`);
        const accept = confirm(`Accepter l'invitation de ${partner} ?`);
        if (accept) {
          fetch("/accept", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ from: myCode, to: partner })
          });
          subscribeToChat(partner);
        } else {
          partner = null;
        }
      }
    });

    inviteChannel.bind("chat-accepted", data => {
      partner = data.from;
      isAccepted = true;
      subscribeToChat(partner);
    });

    function subscribeToChat(other) {
      const chName = "chat_" + [myCode, other].sort().join("_");
      if (currentChannel && currentChannel.name === chName) return;

      if (currentChannel) pusher.unsubscribe(currentChannel.name);
      currentChannel = pusher.subscribe(chName);

      currentChannel.bind("new-message", data => {
        if (data.from === myCode) return;
        addMessage(data.text, false);
      });

      currentChannel.bind("chat-started", data => {
        showNotification(data.message);
        document.getElementById("input-area").style.display = "flex";
        document.getElementById("messages").style.display = "block";
      });

      currentChannel.bind("user-left", data => {
        showNotification(data.message);
        setTimeout(() => {
          document.getElementById("input-area").style.display = "none";
          document.getElementById("messages").style.display = "none";
          document.getElementById("messages").innerHTML = "";
          partner = null;
        }, 5000);
      });

      document.getElementById("messages").style.display = "block";
      document.getElementById("input-area").style.display = "flex";
      document.getElementById("messages").innerHTML = "";
    }

    function sendInvite() {
      const to = document.getElementById("code-input").value.trim();
      if (!to) return;
      partner = to;
      fetch("/invite", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: myCode, to })
      });
      showNotification("ðŸ“© Invitation envoyÃ©e Ã  " + to);
    }

    function sendMessage() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text || !partner) return;
      addMessage(text, true);
      fetch("/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: myCode, to: partner, text })
      });
      input.value = "";
    }

    function quitChat() {
      if (!partner) return;
      fetch("/quit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: myCode, to: partner })
      });
      showNotification("ðŸšª Tu as quittÃ© la conversation");
      document.getElementById("input-area").style.display = "none";
      document.getElementById("messages").style.display = "none";
      document.getElementById("messages").innerHTML = "";
      partner = null;
    }

    function addMessage(text, mine) {
      const div = document.createElement("div");
      div.textContent = (mine ? "Toi" : "Lui") + " : " + text;
      div.className = mine ? "msg mine" : "msg other";
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = 9999;
    }

    function showNotification(msg) {
      const n = document.getElementById("notifications");
      n.textContent = msg;
      n.style.display = "block";
      setTimeout(() => n.style.display = "none", 3000);
    }
  </script>
</body>
</html>
